---
title: "coxkl: Cox Models with KL Divergence for Survival Data Integration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{coxkl Introduction}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options:
  markdown:
    wrap: sentence
# bibliography: references.bib
---



## Introduction:
Prognosis prediction is a crucial aspect of survival analysis. In recent years, the surge of biobank data encompassing diverse high-dimensional risk factors such as genetics, transcriptomics, and electronic health records has opened new avenues for advancing prognosis prediction. Despite this potential, risk prediction for biobank data faces challenges such as limited effective sample sizes, high dimensionality, low signal-to-noise ratios, and patient privacy concerns.

Integrating external information is expected to enhance prediction performance. However, a key issue with classical integration approaches is the assumption of similar underlying distributions across multiple data sources, which often is not the case. Overlooking the heterogeneity among different information sources can introduce significant bias. Consequently, it is crucial to develop a transfer learning procedure that effectively measures the differences between these populations.

Although Kullback-Leibler (KL) divergence has been proposed to integrate external predicted probabilities for binary outcomes, such approaches are not directly applicable to censored time-to-event data due to the complexities of censoring and the typical format of external survival information (e.g., risk scores or coefficients lacking baseline hazard).

To address these issues, the coxkl R package provides a transfer learning-based framework for efficient survival data integration, leveraging external information alongside newly collected time-to-event data. This package offers several key features:

Privacy-Preserving: Requires less sensitive summary statistics (like risk scores or coefficient estimates) from external sources, with no need for individual-level external data.
Robust & Flexible: Handles potential heterogeneity between data sources and supports various formats of external information (coefficients, risk scores, potentially clinical risk groups - check if ranking is implemented).
Adaptive Weighting: Uses tuning parameters (eta) to control the relative weight of external information, prioritizing compatible sources.
High-Dimensionality Support: Implements regularized methods (Ridge, LASSO, Elastic Net via coxkl_highdim) to handle datasets where the number of predictors exceeds the number of observations.
Partial Information Handling: Accommodates scenarios where external studies provide information on only a subset of predictors available in the internal study.
This vignette provides an introduction to the coxkl package and demonstrates its core functionalities.


## Installation:
You can install the development version of coxkl from GitHub using remotes:

## Quick Start
This section provides a brief overview of the main functions using example data included with the package.

First, load the coxkl package:

```{r}
library(coxkll)
```

### Low-Dimensional Integration (coxkl)
The coxkl function is designed for standard settings where the number of predictors is not substantially larger than the sample size. It integrates external information provided either as coefficient estimates (beta) or as pre-calculated risk scores (RS).

Let's load some example data. Assume ExampleData contains covariates z, event status status, survival time time, and externally derived coefficients beta_external.

```{r, eval=FALSE}
# Load example data (Ensure this data is available in your package)
data("ExampleData")
z <- ExampleData$z
delta <- ExampleData$status
time <- ExampleData$time
beta_ext <- ExampleData$beta_external

# Check dimensions
dim(z)
length(delta)
length(time)
length(beta_ext)
```

### Example 1: Integrating external coefficients (`beta`)

We provide the external coefficients via the beta argument and specify a sequence of tuning parameters eta_list.


```{r}
eta_values <- seq(0, 5, by = 1) # Example sequence for eta

fit_beta <- coxkl(z = z,
                  delta = delta,
                  time = time,
                  beta = beta_ext,
                  eta_list = eta_values)

# Results are stored in lists corresponding to eta_list
# Coefficients for the first eta value (eta=0, standard Cox):
print(head(fit_beta$beta_list[[1]]))

# Linear predictors for the third eta value (eta=2):
print(head(fit_beta$LP_list[[3]]))

# The eta values used:
print(fit_beta$eta_list)
```

When `eta` = 0, coxkl fits a standard Cox model without external information. As `eta` increases, the resulting coefficients are increasingly influenced by the provided `beta_ext`.

### Example 2: Integrating external risk scores (`RS`)

Alternatively, we can provide pre-calculated risk scores. Let's calculate them using the external beta for this example.
```{r, eval=FALSE}
# Calculate Risk Score (ensure matrix operations are correct)
rs_ext <- as.matrix(z) %*% as.matrix(beta_ext)

fit_rs <- coxkl(z = z,
                delta = delta,
                time = time,
                RS = rs_ext, # Provide RS instead of beta
                eta_list = eta_values)

# Coefficients for the highest eta value (eta=5):
print(head(fit_rs$beta_list[[length(eta_values)]]))
```

The coxkl function adapts its internal KL divergence calculation based on whether `beta` or `RS` is provided.

(Note: You would typically use cross-validation, potentially via `cv.coxkl`, to select the optimal eta value based on prediction performance on held-out data.)

### High-Dimensional Integration (coxkl_highdim)

For datasets with many predictors ($p > n$), the `coxkl_highdim` function combines KL integration with regularization (Lasso, Ridge, or Elastic Net).

Let's assume `ExampleDataHighDim` provides high-dimensional data (`z`, `status`, `time`). We'll use the previously calculated `rs_ext` as the external information source.

```{r, eval=FALSE}
# data("ExampleDataHighDim") # If you have separate high-dim data

# Using the low-dim data structure for demonstration:
z_highdim <- ExampleData$z
delta_highdim <- ExampleData$status
time_highdim <- ExampleData$time
# rs_ext calculated earlier

# Fit high-dimensional model with Lasso penalty (alpha=1)
fit_highdim <- coxkl_highdim(z = z_highdim,
                             delta = delta_highdim,
                             time = time_highdim,
                             RS = rs_ext, # Provide Risk Score
                             eta_list = 1, # Single eta value for high-dim KL weight
                             alpha = 1,    # Lasso penalty
                             nlambda = 50) # Number of lambda values for regularization path
```


